version: "3.9"
services:
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile
    env_file:
      - .env
    environment:
      - PLATONUS_API_URL=${PLATONUS_API_URL:-http://platonus-api:8001}
    volumes:
      - rag_storage:/app/storage
    ports:
      - "8000:8000"
    depends_on:
      - postgresql
      - qdrant
      - redis

  platonus-api:
    build:
      context: .
      dockerfile: docker/Dockerfile
    env_file:
      - .env
    environment:
      - PLATONUS_API_URL=
    ports:
      - "8001:8001"
    depends_on:
      - postgresql
    command:
      - uvicorn
      - backend.platonus_api.main:app
      - --host
      - 0.0.0.0
      - --port
      - "8001"

  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/api}
    ports:
      - "3000:80"
    depends_on:
      - api

  telegram:
    build:
      context: .
      dockerfile: docker/Dockerfile
    env_file:
      - .env
    environment:
      - PLATONUS_API_URL=${PLATONUS_API_URL:-http://platonus-api:8001}
    depends_on:
      - postgresql
    command:
      - python
      - -m
      - backend.telegram_service.polling

  celery:
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
    env_file:
      - .env
    volumes:
      - rag_storage:/app/storage
    depends_on:
      - postgresql
      - redis

  postgresql:
    image: postgres:15
    environment:
      POSTGRES_USER: bot
      POSTGRES_PASSWORD: bot
      POSTGRES_DB: bot
    ports:
      - "5432:5432"

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

  redis:
    image: redis:7
    ports:
      - "6379:6379"

volumes:
  rag_storage:
    name: academicquestionbot_rag_storage
  qdrant_data:
    name: academicquestionbot_qdrant_data
